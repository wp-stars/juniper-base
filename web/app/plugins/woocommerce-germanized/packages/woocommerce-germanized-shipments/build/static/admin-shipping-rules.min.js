!function(){var e,i,n;e=jQuery,i=wc_gzd_admin_shipping_rules_params,n=wp,ajaxurl,e((function(){var t=e(".wc-gzd-shipments-shipping-rules-rows"),s=e(".wc-gzd-shipments-shipping-rules"),r=n.template("wc-gzd-shipments-shipping-rules-row"),o=n.template("wc-gzd-shipments-shipping-rules-condition-row"),a=n.template("wc-gzd-shipments-shipping-rules-packaging-info"),d={},c=Backbone.Model.extend({updateRules:function(e,i){0===Object.keys(e).length&&(e={});var n={...this.get("rules")};n[String(i)]=e,this.set("rules",n)},updateConditions:function(e,i,n){0===Object.keys(e).length&&(e={});var t="rule_"===String(n).substring(0,5)?n:"rule_"+String(n),s=(n={...this.getRule(i,n)},{...this.get("rules")});n.conditions=e,s[String(i)][t]=n,this.set("rules",s)},getRulesByPackaging:function(e){var i={...this.get("rules")};return i.hasOwnProperty(String(e))?i[String(e)]:{}},getRule:function(e,i){return e=this.getRulesByPackaging(e),i="rule_"===String(i).substring(0,5)?i:"rule_"+String(i),e.hasOwnProperty(i)?e[i]:{}},getConditionsByRuleId:function(e,i){return(e=this.getRule(e,i)).hasOwnProperty("conditions")?e.conditions:{}}}),l=Backbone.View.extend({rowTemplate:r,conditionViews:{},packaging:"",initialize:function(){this.packaging=String(e(this.el).data("packaging")),this.conditionViews={},e(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){e(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){e(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var i=this.getRules(),n=this;this.$el.empty(),this.unblock(),_.size(i)&&e.each(i,(function(e,i){n.renderRow(i)}))},renderRow:function(e){var i=this,n=(i.$el.append(i.rowTemplate(e)),i.$el.find('tr[data-id="'+e.rule_id+'"]'));(n=new u({model:i.model,el:n.find(".wc-gzd-shipments-shipping-rules-condition-rows")[0]})).ruleId=e.rule_id,n.packaging=i.packaging,n.parentView=i,n.render(),i.initRow(e)},initFields:function(i,n){e(document.body).trigger("wc-enhanced-select-init"),i.find("select").each((function(){var i,t=e(this).data("attribute");n[t]&&(t=Array.isArray(n[t])?n[t]:Array(String(n[t])),i=e(this),e.each(t,(function(e,n){0<($isSelected=i.find('option[value="'+String(n)+'"]')).length&&$isSelected.prop("selected",!0)})),i.hasClass("enhanced"))&&i.trigger("change")})),i.find("input.decimal").on("change",{view:this},this.onChangeDecimal),i.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),i.find("input.decimal, input.wc_input_price").trigger("change")},initRow:function(i){var n=this.$el.find('tr[data-id="'+i.rule_id+'"]'),t=n.parents("tbody");this.initFields(n,i),n.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),n.find(".shipping-rule-add").on("click",{view:this},this.onAddRow),t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info").length<=0&&(t.prepend(a),(i=t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info")).find(".packaging-title").html(t.data("title")),t.data("help-tip")?i.find(".woocommerce-help-tip").attr("data-tip",t.data("help-tip")):i.find(".woocommerce-help-tip").remove(),t.data("edit-url"))&&i.find(".packaging-title").attr("href",t.data("edit-url")),e(document.body).trigger("init_tooltips")},onChangeDecimal:function(n){e(this).closest("tr");var t=e(this);t.val(t.val().replace(".",i.decimal_separator))},onChangePrice:function(n){e(this).closest("tr");var t=e(this);t.val(t.val().replace(".",i.price_decimal_separator))},onDeleteRow:function(i){var n=(i=i.data.view).model,t=i.getRules(),s="rule_"+e(this).closest("tr").data("id");return t[s]&&(delete t[s],n.updateRules(t,i.packaging)),i.render(),0<i.$el.find("tr.shipping-rule:last").length&&i.$el.find("tr.shipping-rule:last").addClass("current"),!1},onAddRow:function(i){var n=(i=i.data.view).model,t=i.getRules(),s=t["rule_"+e(this).closest("tr").data("id")],r=_.extend({},s,{rule_id:"new-"+_.size(t)+"-"+Date.now(),newRow:!0,conditions:{},costs:""}),o=0;return e.each(s.conditions,(function(e,i){var n="new-c-"+Date.now()+o;r.conditions["condition_"+n]=_.extend({},i,{condition_id:n,rule_id:r.rule_id,newRow:!0}),o++})),t["rule_"+r.rule_id]=r,n.updateRules(t,i.packaging),i.renderRow(r),i.$el.find('tr[data-id="'+r.rule_id+'"]').trigger("focus"),!1},updateModelOnChange:function(n){var t=n.data.view,s=t.model,r="rule_"+(n=e(n.target)).closest("tr").data("id"),o=n.data("attribute"),a=n.val(),c=t.getRules();return!(0<n.parents(".wc-gzd-shipments-shipping-rules-condition-rows").length||!n.is(":visible"))&&(n.is(":checkbox")?a=n.is(":checked")?a:"":a&&n.hasClass("decimal")?a=parseFloat(a.replace(i.decimal_separator,".")):a&&n.hasClass("wc_input_price")&&(a=parseFloat(a.replace(i.price_decimal_separator,"."))),void(c[r]&&String(c[r][o])===String(a)||(c[r][o]=a,String(c[r].packaging)!==String(t.packaging)?(n=c[r].packaging,(a=(o=d[n]).getRules())[r]={...c[r]},delete c[r],s.updateRules(c,t.packaging),o.model.updateRules(a,n),t.render(),o.render()):s.updateRules(c,t.packaging))))}}),p=new c({rules:i.rules}),u=l.extend({rowTemplate:o,ruleId:0,packaging:"",parentView:!1,initialize:function(){e(this.el).on("change",{view:this},this.updateModelOnChange)},getRules:function(){return this.model.getConditionsByRuleId(this.packaging,this.ruleId)},render:function(){var i=this.getRules(),n=this;this.$el.empty(),_.size(i)&&e.each(i,(function(e,i){n.renderRow(i)}))},renderRow:function(e){this.$el.append(this.rowTemplate(e)),this.initRow(e)},initRow:function(i){var n=this.$el.find('tr[data-condition="'+i.condition_id+'"]');n.parents("tbody"),this.initFields(n,i),0===n.index()&&n.find(".condition-remove").hide(),n.find(".shipping-rules-type-container").hide(),n.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),n.find(".shipping-rules-condition-type").on("change",{view:this},this.onChangeRuleType),n.find(".shipping-rules-condition-type").trigger("change"),n.find(".condition-remove").on("click",{view:this},this.onDeleteRow),n.find(".condition-add").on("click",{view:this},this.onAddRow),e(document.body).trigger("init_tooltips")},onChangeRuleType:function(i){var n=e(this).closest("tr"),t=e(this).val();i=i.data.view,n.find(".shipping-rules-condition-type-container").hide(),n.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),n.find(".shipping-rules-condition-type-container-"+t).show(),0<n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").length?n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").trigger("change"):i.updateModel(n.data("condition"),"operator",""),n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").trigger("change"),n.find(".shipping-rules-condition-type-container-"+t).parents(".conditions-column").show()},updateModel:function(e,i,n){var t=this.model,s=(e="condition_"+e,this.getRules());s[e]&&String(s[e][i])===String(n)||(s[e][i]=n,t.updateConditions(s,this.packaging,this.ruleId))},updateModelOnChange:function(n){var t=n.data.view,s=(n=e(n.target)).closest("tr").data("condition"),r=n.data("attribute"),o=n.val();if(!n.is(":visible"))return!1;n.is(":checkbox")?o=n.is(":checked")?o:"":o&&n.hasClass("decimal")?o=parseFloat(o.replace(i.decimal_separator,".")):o&&n.hasClass("wc_input_price")&&(o=parseFloat(o.replace(i.price_decimal_separator,"."))),t.updateModel(s,r,o)},onDeleteRow:function(i){var n=(i=i.data.view).model,t=i.getRules(),s=e(this).closest("tr"),r="condition_"+s.data("condition");return t[r]&&0!==s.index()&&(delete t[r],n.updateConditions(t,i.packaging,i.ruleId)),i.render(),!1},onAddRow:function(i){var n=(i=i.data.view).model,t=i.getRules(),s=t["condition_"+e(this).closest("tr").data("condition")];return s=_.extend({},s,{condition_id:"new-c-"+_.size(t)+"-"+Date.now(),newRow:!0,costs:""}),-1!==e.inArray(s.type,["weight","total"])&&(s[s.type+"_from"]=s[s.type+"_to"],s[s.type+"_to"]=""),t["condition_"+s.condition_id]=s,n.updateConditions(t,i.packaging,i.ruleId),i.renderRow(s),!1}});t.each((function(){var i=new l({model:p,el:e(this)});i.render(),d[e(this).data("packaging")]=i,e(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(i,n){return n.children().each((function(){e(this).width(e(this).width())})),n.css("left","0"),n},start:function(e,i){i.item.css("background-color","#f6f6f6")},stop:function(e,i){i.item.removeAttr("style"),i.item.trigger("updateMoveButtons"),i.item.trigger("focus")}})})),e(document).on("change",".wc-gzd-shipments-shipping-rules-cb-all",(function(){var i=e(this).parents("table");e(this).is(":checked")?i.find("input.cb").prop("checked",!0):i.find("input.cb").prop("checked",!1)})),e(document).on("click",".wc-gzd-shipments-shipping-rule-add",(function(){var n=e(".new-shipping-packaging").val(),t=d[n],s=t.model.getRulesByPackaging(n),r=_.extend({},i.default_shipping_rule,{rule_id:"new-"+_.size(s)+"-"+Date.now(),packaging:n,newRow:!0}),o="new-c-"+Date.now(),a=r.conditions[0];return r.conditions={},r.conditions["condition_"+o]=_.extend({},a,{condition_id:o,rule_id:r.rule_id,newRow:!0}),s["rule_"+r.rule_id]=r,t.model.updateRules(s,n),d[n].renderRow(r),d[n].$el.find('tr[data-id="'+r.rule_id+'"]').trigger("focus"),!1})),e(document).on("click",".wc-gzd-shipments-shipping-rule-remove",(function(){var i=p.get("rules"),n=e(this),t=n.parents("table"),s=[];return t.find("input.cb:checked").each((function(){var n="rule_"+e(this).val(),t=e(this).parents("tr").find(".shipping-packaging").val();s.includes(t)||s.push(t),delete i[t][n]})),p.set("rules",i),s.forEach((function(e,i){d[e].render()})),n.addClass("disabled"),t.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!1),!1})),e(document).on("keydown",(function(i){var n,t=s.find("tr.current"),r=e(".wc-gzd-shipments-shipping-rules.has-focus");if(0!==t.length||0!==r.length)return!(n=i.metaKey||i.ctrlKey)||"d"!==i.key&&"-"!==i.key?t&&n&&"+"===i.key?(t.find(".shipping-rule-add").trigger("click"),i.preventDefault(),i.stopPropagation(),!1):r&&n&&"a"===i.key?(r.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!r.find(".wc-gzd-shipments-shipping-rules-cb-all").is(":checked")),r.find(".wc-gzd-shipments-shipping-rules-cb-all").trigger("change"),i.preventDefault(),i.stopPropagation(),!1):void 0:(0<($selected=s.find("input.cb:checked")).length?s.find(".wc-gzd-shipments-shipping-rule-remove").trigger("click"):t&&t.find(".shipping-rule-remove").trigger("click"),i.preventDefault(),i.stopPropagation(),!1)})),e(document).on("change",".wc-gzd-shipments-shipping-rules-rows input.cb, .wc-gzd-shipments-shipping-rules-cb-all",(function(){0<($selected=e(this).parents("table").find("input.cb:checked")).length?s.find(".wc-gzd-shipments-shipping-rule-remove").removeClass("disabled"):s.find(".wc-gzd-shipments-shipping-rule-remove").addClass("disabled")})),e(document).on("mouseup",(function(i){var n=e("table.wc-gzd-shipments-shipping-rules");n.is(i.target)||0!==n.has(i.target).length?n.addClass("has-focus"):(n.removeClass("has-focus"),n.find("tr").removeClass("current"))})),e(document).on("click",".wc-gzd-shipments-shipping-rules tbody, .wc-gzd-shipments-shipping-rules input",(function(){e(this).trigger("focus")})),e(document).on("focus click",".wc-gzd-shipments-shipping-rules input, .wc-gzd-shipments-shipping-rules tr",(function(i){e(this).parents("table").find("tr").removeClass("current"),e(this).closest("tr.shipping-rule").addClass("current")}))})),((window.germanizedShipments=window.germanizedShipments||{}).static=window.germanizedShipments.static||{})["admin-shipping-rules.min"]={}}();